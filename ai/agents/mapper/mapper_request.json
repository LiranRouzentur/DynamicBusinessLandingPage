{
  "model": "gpt-4o",
  "temperature": 0.7,
  "system_prompt": "You are `mapper`, an intelligent web research and data enrichment agent.\n\nYour task is to **use Google Maps business data** (as provided in the input schema) to **identify, enrich, validate, and describe** the business.\n\nYou must **query and analyze the web** to produce a concise **business summary**, detect whether it's part of a chain, locate official websites, extract brand visuals (logo, other images, color palette), and collect usable media (images, stock photos). You must then **run the QA/validator suite** below and **fix your output** until it passes all checks or you exhaust the retry budget.\n\n## Task Flow\n\n1. **Understand the Business Context**\n   - Use `name`, `primary_type`, `types`, `formatted_address` to seed queries.\n   - Enrich classification via search until you can write a precise **business_summary** in one sentence.\n   - Example: `Juno` + `restaurant` ‚Üí \"Italian restaurant in Tel Aviv focusing on handmade pasta and Mediterranean wines.\"\n\n2. **Research Brand Identity**\n   - Locate official site (business or chain). Set `business_page_url`.\n   - Extract logo URL (prefer SVG/PNG > 128px).\n   - Extract brand colors: at minimum `primary` and `secondary` as 7‚Äëchar `#RRGGBB`.\n\n3. **Media Enrichment**\n   - Business images: official galleries, Google/Tripadvisor/Yelp where permitted.\n   - Stock images: only from whitelisted free‚Äëstock domains (Unsplash, Pexels, Pixabay). Save direct media URLs.\n\n4. **Assemble Output**\n   - Populate output fields exactly.\n   - Keep arrays unique and ‚â§ 12 items unless otherwise instructed.\n\n5. **Run QA/Validator** (below). If any check fails, **self‚Äëheal** and **re‚Äërun** the suite up to the retry budget.\n\n## QA/Validator Suite\n\nRun all checks locally before emitting output. Each check yields `passed`, and a short `details` if failed.\n\n### 4.1 Schema Compliance\n- Validate output against the JSON output contract.\n- Constraints:\n  - `business_page_url` is null or an absolute URL with protocol.\n  - `business_summary` is 12‚Äì240 chars, declarative, no marketing fluff, no first‚Äëperson.\n  - `assats.logo_url` is null or absolute URL to an image file type (svg|png|jpg|jpeg|webp).\n  - `assats.brand_colors.primary|secondary` are `^#([A-Fa-f0-9]{6})$`.\n  - Arrays contain only unique strings; limit ‚â§ 12 per array.\n\n### 4.2 Consistency Checks\n- `primary_type` must be consistent with `business_summary` (e.g., if type includes `restaurant`, summary must mention cuisine or concept).\n- If `website_url` exists in input, `business_page_url` must either equal it or resolve to its canonical form.\n- If chain detected, `business_summary` must mention chain context (\"part of the X chain\") when relevant.\n\n### 4.3 URL Health & Canonicalization\n**Note: You cannot perform HTTP requests, but you should select URLs that are likely to be valid.**\n\n- **URL Selection Guidelines**:\n  - Normalize to https where possible\n  - Strip tracking params (`utm_*`, `fbclid`, `ref`, etc.)\n  - Prefer direct image CDN URLs over page URLs\n  - For image URLs: Use direct image file URLs (e.g., `images.unsplash.com/photo-...` not `unsplash.com/photos/...`)\n  - Avoid temporary/signed URLs that expire (e.g., Google user content URLs often expire)\n  - Prefer highest‚Äëres image URL where variants are available\n\n- **URL Format Requirements**:\n  - `business_page_url`: Must be absolute URL with protocol (http/https) or null\n  - `logo_url`: Must be absolute URL to an image file (svg|png|jpg|jpeg|webp) or null\n  - `business_images_urls`: Array of absolute image URLs\n  - `stock_images_urls`: Array of absolute image URLs from whitelisted domains\n\n- **Note**: Actual HTTP validation will be performed by the system after your output. Select URLs that follow best practices to maximize validation success.\n\n### 4.4 Image Validation & Domain Policy\n**Note: You cannot decode images, but you must select URLs that follow domain and format policies.**\n\n- **Domain Allow/Deny Policy** (Priority Order):\n  - **HIGHEST PRIORITY - Google Places Business Images**:\n    - `lh3.googleusercontent.com/places` and `*.googleusercontent.com/places` - **PRIORITIZE THESE ABOVE ALL ELSE**. These are official business photos from Google Places. Use these first, especially from `google_data.photos` if available. Only avoid if they clearly show the business in a bad light (e.g., poor conditions, negative reviews visible, etc.).\n    - Business website domains - Use direct image URLs from the business's own website as second priority\n  - **FALLBACK - Stock Image Domains** (use only if Google Places images unavailable or insufficient):\n    - `images.unsplash.com` (CDN direct URLs only - format: `https://images.unsplash.com/photo-<id>?auto=format&fit=max&w=1600&q=80`)\n    - `images.pexels.com` (direct image CDN URLs)\n    - `cdn.pixabay.com` (direct image CDN URLs)\n    - `upload.wikimedia.org` (Wikimedia Commons)\n  - **REJECT**:\n    - `unsplash.com/photos/...` (page URLs - use `images.unsplash.com/photo-...` instead)\n    - Any gallery/page URLs that return HTML instead of images\n    - Domains not on the allowed list unless you have explicit confirmation\n\n- **Stock Image URL Format Requirements**:\n  - Unsplash: MUST be `https://images.unsplash.com/photo-<id>?auto=format&fit=max&w=1600&q=80` or similar CDN format\n  - NEVER use `https://unsplash.com/photos/<id>` - these return HTML pages\n  - If you find an Unsplash photo ID, convert: `unsplash.com/photos/<id>` ‚Üí `images.unsplash.com/photo-<id>?auto=format&fit=max&w=1600&q=80`\n  - Pexels/Pixabay: Use direct CDN image URLs, not gallery pages\n  - All image URLs should point directly to image files (end in .jpg, .png, .webp, .svg, or have proper query params)\n\n- **Image Selection Guidelines**:\n  - Prefer high-resolution images (look for width/height info if available)\n  - Avoid placeholder images or tiny thumbnails\n  - For logos: Prefer SVG or PNG with transparency support\n  - For business images: Prefer images that match the business context\n\n- **Note**: Actual image validation (HTTP GET, decode, dimension checks) will be performed by the system. Select URLs following these guidelines to maximize validation success.\n\n### 4.5 Brand Colors Extraction\n- Colors must be hex `#RRGGBB`.\n- If sampling from a site, derive primary from header/brand elements; secondary from CTA/background.\n- Ensure sufficient contrast for text on white or dark backgrounds (WCAG AA quick check: contrast ratio ‚â• 3:1 for large text).\n\n### 4.6 Chain Detection\n- Verify chain membership by **two independent sources** (e.g., official site + Wikipedia/press page). If not corroborated, do not claim chain status.\n- If chain, prefer **brand‚Äëlevel** logo/colors; if independent franchise, prefer **location‚Äëlevel** imagery but brand‚Äëlevel colors.\n\n### 4.7 Deduplication & Safety\n- Remove duplicate/near‚Äëduplicate image URLs (match by URL stem ignoring query params).\n- No PII leaks from reviews. Do not include scraped personal data.\n- Avoid copyrighted assets that are not clearly licensed.\n\n### 4.8 Completeness & Self-Healing Strategies\n- If `business_page_url` is absent and an obvious official domain exists on first two SERP pages, keep searching (retry budget permitting).\n- **Logo Self-Heal Strategy** (if `logo_url` fails validation):\n  Try in order:\n  1. Brand site favicon/apple-touch-icon (`/favicon.ico`, `/apple-touch-icon.png`)\n  2. Common paths: `/<logo>.svg|.png`, `/assets/logo.svg`, `/logo/logo.svg`\n  3. `og:image` only if it looks like a logo (check dimensions, transparency, aspect ratio)\n  4. Wikipedia file on `upload.wikimedia.org` (e.g., search Wikimedia Commons)\n  5. If all fail, set `logo_url` to `null` and continue\n\n- **Business Images Self-Heal Strategy** (if initial URLs are invalid):\n  - **PRIORITIZE**: First try Google Places images from `google_data.photos` (if available) - these are official business photos\n  - If Google Places images fail validation or are unavailable, backfill with stock images from whitelisted domains\n  - Ensure at least 2-4 business images total\n  - Example: Pizza restaurant ‚Üí prioritize `lh3.googleusercontent.com/places` URLs, fallback to `images.unsplash.com/photo-...` URLs related to pizza/Italian cuisine if needed\n  - Ensure replacement URLs follow the proper CDN format from the whitelist\n\n- **Stock Images Self-Heal Strategy** (if initial URLs are invalid):\n  - If you identified an Unsplash photo but have a page URL (`unsplash.com/photos/...`), convert to CDN: `images.unsplash.com/photo-<id>?auto=format&fit=max&w=1600&q=80`\n  - If you have a page URL that returns HTML, find the direct image CDN URL instead\n  - Select different stock images from whitelist if needed\n  - Enforce array limits (‚â§12) after repair\n\n### 4.9 Retry Budget & Backoff\n- `max_retries = 3`. After each failing run, apply targeted corrections only for failing checks, re‚Äëquery as needed. Exponential backoff suggestions: 0s, 2s, 5s.\n\n## Self‚ÄëHealing Execution Plan\n\nImplement a **plan‚Äëproduce‚Äëvalidate‚Äërepair** loop:\n\n1. **Plan**: List hypotheses: business nature, likely domain candidates, imagery sources.\n2. **Produce**: Draft the output JSON once.\n3. **Validate**: Run all QA checks from section 4. Build a `qa_report` with pass/fail per check.\n4. **Repair**: For each failed check, perform minimal additional search/extraction and correct fields.\n5. **Re‚Äëvalidate**: Re‚Äërun the validator. Stop only when all checks pass or `max_retries` reached.\n6. **Emit**: Emit final JSON (optionally include `qa_report`).\n\nYou must ensure your output passes all QA checks before returning. If checks fail, internally fix and retry up to 3 times.",
  "user_message": {
    "google_data": {
      "place_id": "ChIJuzL4KZ5LHRURmodwHUMNVPQ",
      "name": "places/ChIJuzL4KZ5LHRURmodwHUMNVPQ",
      "formatted_address": "Yigal Alon St 90, Tel Aviv-Yafo, Israel",
      "types": [
        "meal_delivery",
        "meal_takeaway",
        "food_delivery",
        "pizza_restaurant",
        "restaurant",
        "food",
        "point_of_interest",
        "establishment"
      ],
      "primary_type": "meal_delivery",
      "website_url": "https://www.dominos.co.il/%D7%A1%D7%A0%D7%99%D7%A3-%D7%99%D7%92%D7%90%D7%9C-%D7%90%D7%9C%D7%95%D7%9F",
      "google_maps_url": "https://maps.google.com/?cid=17605711425205995418&g_mp=CiVnb29nbGUubWFwcy5wbGFjZXMudjEuUGxhY2VzLkdldFBsYWNlEAIYBCAA",
      "location": {
        "latitude": 32.0673618,
        "longitude": 34.793285499999996
      },
      "viewport": {
        "low": {
          "latitude": 32.0660357697085,
          "longitude": 34.791829869708494
        },
        "high": {
          "latitude": 32.0687337302915,
          "longitude": 34.79452783029149
        }
      },
      "contact": {
        "international_phone": "+972 76-804-8974"
      },
      "status": {
        "open_now": true,
        "weekday_descriptions": [
          "Monday: 12:00‚ÄØPM‚Äâ‚Äì‚Äâ12:00‚ÄØAM",
          "Tuesday: 12:00‚ÄØPM‚Äâ‚Äì‚Äâ12:00‚ÄØAM",
          "Wednesday: 12:00‚ÄØPM‚Äâ‚Äì‚Äâ12:00‚ÄØAM",
          "Thursday: 12:00‚ÄØPM‚Äâ‚Äì‚Äâ12:00‚ÄØAM",
          "Friday: 12:00‚ÄØPM‚Äâ‚Äì‚Äâ12:00‚ÄØAM",
          "Saturday: 12:00‚ÄØPM‚Äâ‚Äì‚Äâ12:00‚ÄØAM",
          "Sunday: 12:00‚ÄØPM‚Äâ‚Äì‚Äâ12:00‚ÄØAM"
        ]
      },
      "rating": 3,
      "user_rating_count": 386,
      "price_level": "PRICE_LEVEL_MODERATE",
      "editorial_summary": null,
      "reviews": [
        {
          "rating": 1,
          "text": "Avoid at all costs, delivery tracking was slowly progressing and delaying for 2 hours until suddenly it said ‚Äúarrived‚Äù, but no pizza was ever delivered.\n\nCustomer support is unavailable, nobody to talk to, and best they can do is refund a day after.\n\nYou better off making homemade pizza instead of relying on this place.",
          "publish_time": "2025-09-15T16:57:30.054436146Z",
          "relative_time": "a month ago",
          "author": "Igor Okun",
          "author_uri": "https://www.google.com/maps/contrib/102915599455007370596/reviews",
          "author_photo_uri": "https://lh3.googleusercontent.com/a/ACg8ocLRyKIuGKFnnuPpH9xMuw-T3_UVKyt-KHqXc9tKTsjsjBzcrw=s128-c0x00000000-cc-rp-mo"
        },
        {
          "rating": 1,
          "text": "Terrible service, did not deliver the pizza, and the marked the delivery as done. No one to talk with",
          "publish_time": "2025-06-23T20:36:37.032503191Z",
          "relative_time": "4 months ago",
          "author": "Liad Harduf",
          "author_uri": "https://www.google.com/maps/contrib/108436987769492873418/reviews",
          "author_photo_uri": "https://lh3.googleusercontent.com/a-/ALV-UjW73HtQbIHZMuwMMmR47GDfXv00aVetyfq8YHluMnqaFUWHgWncfg=s128-c0x00000000-cc-rp-mo-ba4"
        },
        {
          "rating": 1,
          "text": "AVOID AT ALL COSTS\nDELIVERY TAKES FOREVER, THE PIZZA ARRIVES COLD, NOBODY TO TALK TO OR SPEAK TO.",
          "publish_time": "2025-08-08T13:26:21.954098444Z",
          "relative_time": "2 months ago",
          "author": "youvebeenzapped",
          "author_uri": "https://www.google.com/maps/contrib/102890531848193072282/reviews",
          "author_photo_uri": "https://lh3.googleusercontent.com/a/ACg8ocJnN-cRSbxIltTaIh2a3c3WMETul4en5HbL6m6vv7kUQQZXIw=s128-c0x00000000-cc-rp-mo-ba3"
        },
        {
          "rating": 1,
          "text": "It taken them hour and a half to deliver the pizza and I am five minutes away from them I couldn‚Äôt go there by myself because I‚Äôm in the hospital nearby and still took them in an hour and a half to deliver the pizza and when I was calling them, they‚Äôre  telling me why you cannot come to take the pizza if it‚Äôs  five minutes away why do you need the delivery? So rude and disrespectful for the patients in the hospital üò°",
          "publish_time": "2024-12-21T16:53:52.878538Z",
          "relative_time": "10 months ago",
          "author": "Leon Pabrekar",
          "author_uri": "https://www.google.com/maps/contrib/104731655950270790176/reviews",
          "author_photo_uri": "https://lh3.googleusercontent.com/a/ACg8ocLkoNBTOrbbPdclne5bhC-wiPM_8sfILmcOf2ayLs-vXezG0g=s128-c0x00000000-cc-rp-mo"
        },
        {
          "rating": 1,
          "text": "Just no!\nWhat an horrible experience.\nNot only the prices went sky high to a mediocre pizza\nThe service, that once was good, hit rock bottom.\nAfter ordering on the app, and the pizza was nowhere to be seen over an hour. It was immposibble to reach them on the phone. The chat took it's time to figure out the issue, the order never arrived the\nBranch.\nYou lost a regular, I'll no longer order pizza from  you or any of your branches.",
          "publish_time": "2023-06-10T12:37:40.799379Z",
          "relative_time": "2 years ago",
          "author": "ido ori",
          "author_uri": "https://www.google.com/maps/contrib/104516852945672106127/reviews",
          "author_photo_uri": "https://lh3.googleusercontent.com/a/ACg8ocI9QfgTCiQb66j270oZSD8vCUV6S5dawlCSwIEHTZW0yUWscTY=s128-c0x00000000-cc-rp-mo-ba3"
        }
      ],
      "photos": [
        {
          "name": "places/ChIJuzL4KZ5LHRURmodwHUMNVPQ/photos/AWn5SU4O0pw6dHGwh222fTW75itL_tOOUpTyvBy0uWt_6MHpZRkxMFdwC0dIBq_X4AVUHGIMa5Q405pVQFkH0bFuun97b7k7JpyrfzNxmcdwKMLggK79tTzuX41iP84UWQlQcnm1fKQQZFSJZjeI8GE4RVHsOVhXv2IN4HFcvyNm8Grhqd6ZUBIwleK4Fk7_lNJA8Vnyuy4Plhe2VS2ohQ3CJYnclTPF4oWWwKKVrU7FV_DjVbDa5P3VI-5f8l5UTpCuObOKdC4e0LfoLBEduamDzHPVTfpfViF2Vf11LM5FtwMzty1VpXUQbToNWzP7Ii5wPcYSXfHxBMEcjbGk1L8eG64Dk9TxjzvzGCLOQiTCmlhsXVacizj8hS3UPLM1a18k71mxgCJCet2ZylwnVTxHUPsDsbHZdzuFVjWCEiyIsjGuY-nB",
          "width_px": 4000,
          "height_px": 3000,
          "author_attributions": [
            {
              "displayName": "Yael David",
              "uri": "https://maps.google.com/maps/contrib/102944617577076592284",
              "photoUri": "https://lh3.googleusercontent.com/a/ACg8ocJuDkFoohotAo4Lk18wFCLyB1S56W20f6o4nbIqL6yCHYbOVBKo=s100-p-k-no-mo"
            }
          ],
          "download_uri": "https://lh3.googleusercontent.com/place-photos/AEkURDy9JAjiVXVSOph8OeQgf-qqQ-iEYkIIWhix_paQnZ8nyVTtqQBrRJUl853VHNjkgB2IOlFd502_lruJrmPr41DGZgCk6kzigQLoNY_o-d4-9rNpxux_Wz51NikK6XIkjSul6jiDrMVJ9_J2L5M=s4800-w1600"
        },
        {
          "name": "places/ChIJuzL4KZ5LHRURmodwHUMNVPQ/photos/AWn5SU76utBOSaGe8RVbktjf3Q663LKkDjtt1vyVpY_nt51whzuDnguodhAQJzi_Bcd3CzkVXtBgrrmj88iRL0sz7FljChk4Agn6TRBt_x-6nc9-3KZAbu_T0UAMM68iMok5arI7_1DpYFcXJ0tRPQluldQsZf5ZjqTiUZ9wiv6sEvcdq4DD1yuPJ9B4XBFq2yJ3pcq02AIGGOfxLA4Akb_kBmHWqu4Wieh5o5PRhp6BEUdqAnr2_d_vkBMhNEEVh33vds7X5CUc_pFtYAbqV2M--M9Rq0-HIDXlyvWoYdfgJL3mtA",
          "width_px": 870,
          "height_px": 630,
          "author_attributions": [
            {
              "displayName": "◊ì◊ï◊û◊ô◊†◊ï◊° ◊§◊ô◊¶◊î ◊™◊ú ◊ê◊ë◊ô◊ë - ◊ô◊í◊ê◊ú ◊ê◊ú◊ï◊ü",
              "uri": "https://maps.google.com/maps/contrib/100866571042272672329",
              "photoUri": "https://lh3.googleusercontent.com/a-/ALV-UjXo1vNl-nF2P1E-B5PsCtH-6xPh12eKWBGCPBN8w9M5DCm8w_U=s100-p-k-no-mo"
            }
          ],
          "download_uri": "https://lh3.googleusercontent.com/places/ANXAkqGJEFcttlYH_AhTm33NHw_J8TG8diOcCqxWrpq5qYYMfnqKHIjFrzNcnMTLsG3tfjsqghmv8aImUgxmKa0bwxslBwra6zncv-A=s4800-w870"
        },
        {
          "name": "places/ChIJuzL4KZ5LHRURmodwHUMNVPQ/photos/AWn5SU4C70kA7X46Q99v3qJfrbeyN0EAMaW_hYKtcJ1RtUb0AL6H6YmYAsk3Rp2m32Rx6WyyRaWy25Wx5WGr1MRfVtStJY18i09nIdztJ8BYVSBQE_AdYPPGrEUY7Bn7AT8aQ4lsmZ01CmYaPpOJ30HWdfXeV1Ro51KvPbDBkYpjl8JSrA6f7nH0rbSG3x7jXMwqmIR-9Z8JGOOq-zddJ357Duj_wIOg7o4625lulQrRE5xvo3WgyE99XZQzCFLB5ZdxKC4vEUX2GUFjCFL5lIDwFFBPpiSWOdIVmM0wFPJSgnUAsg",
          "width_px": 2001,
          "height_px": 1500,
          "author_attributions": [
            {
              "displayName": "◊ì◊ï◊û◊ô◊†◊ï◊° ◊§◊ô◊¶◊î ◊™◊ú ◊ê◊ë◊ô◊ë - ◊ô◊í◊ê◊ú ◊ê◊ú◊ï◊ü",
              "uri": "https://maps.google.com/maps/contrib/100866571042272672329",
              "photoUri": "https://lh3.googleusercontent.com/a-/ALV-UjXo1vNl-nF2P1E-B5PsCtH-6xPh12eKWBGCPBN8w9M5DCm8w_U=s100-p-k-no-mo"
            }
          ],
          "download_uri": "https://lh3.googleusercontent.com/places/ANXAkqHKAdwgRXKIk62TCKzqL79jf6UV-meDYW4Nh77JKslk_SII9rTHojd7maSoTbkbE2_IGbGQCCEuRMGR7n6E2YmwI43jajioK_w=s4800-w1600"
        },
        {
          "name": "places/ChIJuzL4KZ5LHRURmodwHUMNVPQ/photos/AWn5SU7njs2J3erX2e8kDIV-HyURqO24FvQFXz-WK9_L9PU3fhQNaTLvZt64nKliSt7QLmUPiKx-WWCacjNZSqEHUqiwnUU9mFKiBjys4x0_8skKCFfAPVi3t2nnQEQNHlx5_VvarHwVB8olIKvbY8F-VDK2UoXbw62K3Eeg60IK35-wD6ZwI6Lgaa-37eIVqXPMezuBirYXS_NUs_NNd9M7QTEY_kI9OlNoIMlmZIxiYllar3VOkmVwSlm6WrUQK6619waaf3ceC8Xhi6MACSmYD_U7RPfzSBO0aAkYUsn9sn2iRg",
          "width_px": 2001,
          "height_px": 1500,
          "author_attributions": [
            {
              "displayName": "◊ì◊ï◊û◊ô◊†◊ï◊° ◊§◊ô◊¶◊î ◊™◊ú ◊ê◊ë◊ô◊ë - ◊ô◊í◊ê◊ú ◊ê◊ú◊ï◊ü",
              "uri": "https://maps.google.com/maps/contrib/100866571042272672329",
              "photoUri": "https://lh3.googleusercontent.com/a-/ALV-UjXo1vNl-nF2P1E-B5PsCtH-6xPh12eKWBGCPBN8w9M5DCm8w_U=s100-p-k-no-mo"
            }
          ],
          "download_uri": "https://lh3.googleusercontent.com/places/ANXAkqFsrqqHTEVAGcm7le4ggGHBCIxNMmP8UUi1AWoAoukcIPJbhV4-Bbk79yiwJqaMYXFOstbEazQq6Zg8wVx8gyHr2MVAaQtWF-s=s4800-w1600"
        }
      ]
    }
  },
  "has_response_schema": true
}